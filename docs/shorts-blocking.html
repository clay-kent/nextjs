  <h1>Tailscale + mitmproxy による YouTube Shorts 検閲環境の構築</h1>

  <p><strong>作成日:</strong> 2026年2月2日<br><strong>最終更新:</strong> 2026年2月20日 23:16</p>

  <h2>はじめに</h2>

  <h3>前提条件</h3>
  <p>Tailscale及びmitmproxyはサーバーもクライアントも、ネットにつながる一般的なOSのデバイスなら動くが、本文中のコマンド・コードは以下を前提にして記載する。</p>

  <h4>サーバー環境</h4>
  <ul>
    <li>OS: Ubuntu 22.04 LTS (x86_64): root権限あり、実機環境</li>
    <li>Tailscaleをインストール済み: アカウントを作成し、管理コンソールにアクセス可能なTailnetに参加済</li>
    <li>インターネットに接続済（HTTPS 通信が可能）</li>
  </ul>

  <h4>スマホ(クライアント)</h4>
  <ul>
    <li>iOS または Androidのスマホ</li>
    <li>CA証明書をインストールできる</li>
    <li>Tailscaleアプリをインストールして、サーバーと同じTailnetに参加済み</li>
    <li>YouTube公式アプリではなく、ブラウザ（Safari/Chrome等）を対象</li>
  </ul>

  <h4>バージョン</h4>
  <ul>
    <li>tailscale 1.92.1</li>
    <li>mitmproxy 8.1.1</li>
    <li>Python 3.12.3</li>
  </ul>

  <h3>目的</h3>
  <p>YouTube Shortsへのアクセスをブロックしたい。ただしドメイン丸ごとのブロックは避け、mitmproxyでURL全文を確認してブロックする。中継は自宅サーバーを使い、ポート開放ができないため Tailscale を経由する。</p>

  <ul>
    <li>クライアントの全通信が Exit Node 経由で正常に行われること</li>
    <li><code>youtube.com/shorts/</code> を含むリクエストに対し mitmproxy が 403 を返すこと</li>
    <li>通常の動画視聴（/watch?v=...）や他サイトの閲覧に影響を出さないこと</li>
  </ul>

  <h3>Tailscaleとは / mitmproxyとは</h3>
  <p>Tailscale は WireGuard ベースの簡易 VPN、Exit Node 機能によりサーバー経由で通信を中継できる。mitmproxy は Python 製の L7 プロキシで、通信の解析・改変が可能。</p>

  <h3>システム構成図</h3>
    <div class="mermaid">
graph TD
    subgraph Client ["クライアント (モバイルブラウザ)"]
        A[YouTubeのリクエスト]
    end

    subgraph Tunnel ["Tailscale Tunnel"]
        B[カプセル化されたパケット]
    end

    subgraph Server ["終端ノード (自宅サーバー)"]
        direction TB
        C["tailscale0 (仮想インターフェース)"]
        subgraph Netfilter ["カーネル空間"]
            D{"PREROUTING (DNAT)"}
            E{"FORWARD (UDP 443 Reject)"}
        end
        subgraph L7_Proxy ["ユーザー空間 (mitmproxy)"]
            F[mitmproxy:8080]
            G[block_shorts.py]
        end
        H["eth0 (物理インターフェース)"]
    end

    A --> B --> C
    C --> D
    D -- "TCP 80/443" --> F
    F <--> G
    F --> H
    C --> E
    E -- "UDP 443 REJECT" --> C
    H --> I[インターネット]
    I --> Y[Youtubeのサーバー]
    </div>

  <p>L3（Exit Node）で集約したトラフィックを netfilter（iptables）の DNAT で mitmproxy に透過的にリダイレクトし、URL を検査してブロックする。</p>

  <h2>Tailscale Exit Node 設定</h2>
  <p>公式ドキュメントに沿って Exit Node を有効化する（例: <a href="https://tailscale.com/kb/1103/exit-nodes?tab=linux">https://tailscale.com/kb/1103/exit-nodes?tab=linux</a>）。</p>

  <h3>カーネル・パケットフォワーディングの有効化</h3>
  <pre><code class="language-bash"># IPv4のIPフォワーディングを有効化
echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
# IPv6のIPフォワーディングを有効化
echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.d/99-sudo sysctl -p /etc/sysctl.d/99-tailscale.conf
</code></pre>

  <p>サーバーを Exit Node としてアドバタイズする:</p>
  <pre><code class="language-bash">sudo tailscale set --advertise-exit-node
sudo tailscale up
</code></pre>

  <h3>クライアント側</h3>
  <p>iOS は Tailscale アプリから Exit Node を選択して有効化する。</p>

  <h2>透過プロキシ用 Netfilter ルール</h2>
  <p>tailscale0 から来る外向き TCP 80/443 をローカルの 8080 (mitmproxy) へ REDIRECT する例:</p>
  <pre><code class="language-bash">sudo iptables -t nat -A PREROUTING -i tailscale0 -p tcp ! -d 100.64.0.0/10 --dport 80 -j REDIRECT --to-ports 8080
sudo iptables -t nat -A PREROUTING -i tailscale0 -p tcp ! -d 100.64.0.0/10 --dport 443 -j REDIRECT --to-ports 8080
</code></pre>

  <p>IPv6 および QUIC(UDP/443) の扱いについても説明と例を記載しています。QUIC は UDP なので、QUIC を拒否して TCP にフォールバックさせるために UDP 443 を拒否するルールを入れる例を示しています。</p>

  <pre><code class="language-bash">sudo iptables -I FORWARD 1 -i tailscale0 -p udp --dport 443 -j REJECT
sudo ip6tables -I FORWARD 1 -i tailscale0 -p udp --dport 443 -j REJECT
</code></pre>

  <h2>mitmproxy の設定</h2>
  <h3>証明書の信頼設定</h3>
  <p>iOS の場合は <a href="http://mitm.it/">mitm.it</a> にアクセスしてプロファイルをインストールし、証明書信頼設定をオンにする必要があります。</p>

  <h3>URL ブロックスクリプト</h3>
  <p>例: <code>/opt/mitmproxy/scripts/block_shorts.py</code></p>
  <pre><code class="language-python">from mitmproxy import http

# YouTube Shorts URL シグネチャの定義
SHORTS_SIGNATURE = "youtube.com/shorts"

def request(flow: http.HTTPFlow) -> None:
    if SHORTS_SIGNATURE in flow.request.pretty_url:
        flow.response = http.Response.make(
            403,
            b"Content Blocked: YouTube Shorts is restricted in this environment.",
            {"Content-Type": "text/plain"}
        )
        print(f"[BLOCKED] {flow.request.pretty_url}")
</code></pre>

  <p>スクリプト付きで mitmproxy を起動:</p>
  <pre><code class="language-bash">mitmproxy --mode transparent --listen-port 8080 -s /opt/mitmproxy/scripts/block_shorts.py
</code></pre>

  <h2>永続化</h2>
  <p>iptables の永続化や、systemd ユニットによる mitmproxy の自動起動例も記載しています。</p>

  <h3>iptables 永続化</h3>
  <pre><code class="language-bash">sudo apt update && sudo apt install iptables-persistent
sudo netfilter-persistent save
</code></pre>

  <h3>systemd ユニット例</h3>
  <pre><code class="language-toml">[Unit]
Description=mitmproxy transparent proxy for YouTube Shorts blocking
After=network.target tailscaled.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/mitmproxy
ExecStart=/usr/local/bin/mitmproxy --mode transparent --showhost --listen-port 8080 -s scripts/block_shorts.py
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre>

  <p>systemd の操作例:</p>
  <pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl start mitmproxy.service
sudo systemctl enable mitmproxy.service
sudo systemctl status mitmproxy.service
sudo journalctl -u mitmproxy.service -f
</code></pre>

  <p>以上で、YouTube Shorts の URL を検査して 403 を返す透過プロキシ構成の手順書（HTML化）です。</p>
